{% extends "shop/base_shop.html" %}
{% load static %}

{% block shop_content %}
<div class="container py-4 py-md-5">
    <!-- Shop Header -->
    <div class="row align-items-center mb-4 mb-md-5">
        <div class="col-md-8">
            <h1 class="display-5 fw-bold mb-2" style="color: #6f4e37;">Shop Products</h1>
            <p class="lead" style="color: #4b2c20;">
                Discover our premium selection of One Cup Initiative products. Every purchase supports sustainable coffee farming.
            </p>
        </div>
        <div class="col-md-4 text-md-end mt-3 mt-md-0">
            {% if user.is_authenticated %}
            <a href="{% url 'shop:view_wishlist' %}" class="btn btn-lg me-2" style="background-color: #ffffff; color: #8f521b; border: 2px solid #8f521b;">
                <i class="far fa-heart me-2"></i> Wishlist
            </a>
            {% endif %}
            <a href="{% url 'shop:view_cart' %}" class="btn btn-lg position-relative" style="background-color: #8f521b; color: #ffffff; border: none;">
                <i class="fas fa-shopping-basket me-2"></i> View Cart
                {% if cart_count and cart_count > 0 %}
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-warning text-dark">
                        {{ cart_count }}
                        <span class="visually-hidden">items in cart</span>
                    </span>
                {% endif %}
            </a>
        </div>
    </div>

    <!-- Success Message -->
    {% if request.GET.success %}
    <div id="order-success-message" class="alert alert-success alert-dismissible fade show shadow-sm" role="alert">
        <div class="d-flex align-items-center">
            <i class="fas fa-check-circle me-3 fs-4"></i>
            <div>
                <h5 class="alert-heading mb-1">Thank you for your order!</h5>
                <p class="mb-0">Your order has been received and is being processed. You'll receive a confirmation email shortly.</p>
            </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    <script>
        // Auto-dismiss after 8 seconds
        setTimeout(function() {
            var alert = document.getElementById('order-success-message');
            if (alert) {
                var bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }
        }, 8000);
    </script>
    {% endif %}

    <!-- Categories Filter -->
    {% if categories %}
    <div class="mb-4">
        <div class="d-flex flex-wrap align-items-center mb-3">
            <h5 class="me-3 mb-0" style="color: #4b2c20;">Filter by:</h5>
            <div class="btn-group flex-wrap" role="group" aria-label="Product categories">
                <a href="{% url 'shop:product_list' %}" 
                   class="btn {% if not active_category %}active{% endif %}" style="{% if not active_category %}background-color: #8f521b; color: #ffffff; border-color: #8f521b;{% else %}background-color: #ffffff; color: #8f521b; border: 1px solid #8f521b;{% endif %}">
                    All Products
                </a>
                {% for category in categories %}
                    <a href="{% url 'shop:product_list' %}?category={{ category.slug }}" 
                       class="btn {% if active_category == category.slug %}active{% endif %}" style="{% if active_category == category.slug %}background-color: #8f521b; color: #ffffff; border-color: #8f521b;{% else %}background-color: #ffffff; color: #8f521b; border: 1px solid #8f521b;{% endif %}">
                        {{ category.name }}
                        {% if category.product_count %}
                            <span class="badge bg-warning text-dark ms-1">{{ category.product_count }}</span>
                        {% endif %}
                    </a>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Product Count and Sort -->
    <div class="row mb-4">
        <div class="col-md-6">
            <p class="mb-0" style="color: #4b2c20;">
                Showing <span class="fw-semibold" style="color: #8f521b;">{{ products|length }}</span> 
                of <span class="fw-semibold" style="color: #8f521b;">{{ total_products }}</span> products
                {% if active_category %} in <span class="fw-semibold" style="color: #8f521b;">{{ active_category|title }}</span>{% endif %}
            </p>
        </div>
        <div class="col-md-6 text-md-end">
            <div class="dropdown d-inline-block">
                <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" style="background-color: #ffffff; color: #8f521b; border: 1px solid #8f521b;">
                    <i class="fas fa-sort me-1"></i>
                    {% if sort_by == 'name' %}Name A-Z
                    {% elif sort_by == '-name' %}Name Z-A
                    {% elif sort_by == 'price' %}Price: Low to High
                    {% elif sort_by == '-price' %}Price: High to Low
                    {% elif sort_by == '-created_at' %}Newest First
                    {% elif sort_by == 'created_at' %}Oldest First
                    {% else %}Sort by
                    {% endif %}
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="?sort=name">Name A-Z</a></li>
                    <li><a class="dropdown-item" href="?sort=-name">Name Z-A</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="?sort=price">Price: Low to High</a></li>
                    <li><a class="dropdown-item" href="?sort=-price">Price: High to Low</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="?sort=-created_at">Newest First</a></li>
                    <li><a class="dropdown-item" href="?sort=created_at">Oldest First</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Product Grid -->
    {% if products %}
    <div class="row g-4 mb-5">
        {% for product in products %}
        <div class="col-lg-4 col-md-6">
            <div class="card h-100 border-0 shadow-sm hover-lift transition-all">
                <!-- Product Image -->
                <div class="position-relative overflow-hidden" style="height: 250px;">
                    {% if product.image %}
                    <img src="{{ product.image.url }}" 
                         alt="{{ product.name }}" 
                         class="card-img-top h-100 object-fit-cover">
                    {% else %}
                    <div class="h-100 bg-beige d-flex align-items-center justify-content-center">
                        <i class="fas fa-coffee fa-3x text-dark opacity-50"></i>
                    </div>
                    {% endif %}
                    
                    <!-- Product Badges -->
                    <div class="position-absolute top-0 start-0 p-3">
                        {% if product.is_new %}
                        <span class="badge" style="background-color: #fd9d02; color: #000000;">New</span>
                        {% endif %}
                        {% if product.is_featured %}
                        <span class="badge" style="background-color: #8f521b; color: #ffffff;">Featured</span>
                        {% endif %}
                        {% if product.stock_quantity <= 10 and product.stock_quantity > 0 %}
                        <span class="badge" style="background-color: #6f4e37; color: #ffffff;">Low Stock</span>
                        {% endif %}
                    </div>
                    
                    <!-- Stock Status -->
                    {% if product.show_stock_publicly and product.stock_quantity is not None %}
                    <div class="position-absolute bottom-0 start-0 end-0 p-3 bg-dark bg-opacity-75">
                        {% if product.stock_quantity > 0 %}
                        <p class="mb-0 text-white small">
                            <i class="fas fa-check-circle me-1 text-success"></i>
                            In Stock: {{ product.stock_quantity }} units
                        </p>
                        {% else %}
                        <p class="mb-0 text-white small">
                            <i class="fas fa-times-circle me-1 text-danger"></i>
                            Out of Stock
                        </p>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                
                <div class="card-body d-flex flex-column">
                    <!-- Product Category -->
                    {% if product.category %}
                    <div class="mb-2">
                        <span class="badge" style="background-color: #faf0e6; color: #4b2c20; border: 1px solid #8f521b;">{{ product.category.name }}</span>
                    </div>
                    {% endif %}
                    
                    <!-- Product Name -->
                    <h5 class="card-title text-dark mb-2">{{ product.name }}</h5>
                    
                    <!-- Product Description -->
                    <p class="card-text text-muted flex-grow-1 mb-3">
                        {{ product.description|truncatechars:120 }}
                    </p>
                    
                    <!-- Price and Rating -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h4 class="text-dark mb-0">{{ product.price }} {{ product.currency }}</h4>
                            {% if product.compare_price %}
                            <p class="text-muted text-decoration-line-through mb-0 small">{{ product.compare_price }} {{ product.currency }}</p>
                            {% endif %}
                        </div>
                        {% if product.average_rating %}
                        <div class="text-warning">
                            <i class="fas fa-star"></i>
                            <span class="text-dark fw-semibold">{{ product.average_rating|floatformat:1 }}</span>
                            <small class="text-muted">({{ product.review_count }})</small>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Add to Cart Form -->
                    <form method="post" action="{% url 'shop:add_to_cart' %}" class="mt-auto">
                        {% csrf_token %}
                        <input type="hidden" name="product_id" value="{{ product.id }}">
                        <div class="input-group">
                            {% if product.stock_quantity > 0 %}
                            <input type="number" 
                                   name="quantity" 
                                   value="1" 
                                   min="1" 
                                   max="{{ product.stock_quantity }}"
                                   class="form-control" 
                                   style="max-width: 80px;"
                                   aria-label="Quantity">
                            <button type="submit" class="btn flex-grow-1" style="background-color: #8f521b; color: #ffffff; border: none;">
                                <i class="fas fa-shopping-cart me-2"></i>Add to Cart
                            </button>
                            {% else %}
                            <button type="button" class="btn flex-grow-1" disabled style="background-color: #e0e0e0; color: #666666; border: 1px solid #cccccc;">
                                <i class="fas fa-bell me-2"></i>Notify When Available
                            </button>
                            {% endif %}
                        </div>
                    </form>
                    
                    <!-- Quick Actions -->
                    <div class="d-flex justify-content-between mt-3">
                        <a href="{% url 'shop:product_detail' product.slug %}" 
                           class="text-decoration-none small" style="color: #8f521b;">
                            <i class="fas fa-eye me-1"></i>View Details
                        </a>
                        {% if user.is_authenticated %}
                        <button class="btn btn-link text-decoration-none small p-0"
                                onclick="addToWishlist({{ product.id }})" style="color: #8f521b;">
                            <i class="far fa-heart me-1"></i>Save
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
    <nav aria-label="Product pagination" class="mt-5">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if active_category %}&category={{ active_category }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link">&laquo;</span>
            </li>
            {% endif %}
            
            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}{% if active_category %}&category={{ active_category }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}">{{ num }}</a>
                </li>
                {% endif %}
            {% endfor %}
            
            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if active_category %}&category={{ active_category }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link">&raquo;</span>
            </li>
            {% endif %}
        </ul>
        <p class="text-center text-muted mt-2">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
        </p>
    </nav>
    {% endif %}

    {% else %}
    <!-- Empty State -->
    <div class="text-center py-5 my-5">
        <div class="mb-4">
            <i class="fas fa-coffee fa-4x text-beige"></i>
        </div>
        <h3 class="mb-3 text-dark">No Products Available</h3>
        <p class="text-muted mb-4">We're currently updating our product catalog. Check back soon for our latest offerings.</p>
        <div class="d-flex justify-content-center gap-3">
            <a href="{% url 'shop:product_list' %}" class="btn btn-dark">
                <i class="fas fa-redo me-2"></i>View All Products
            </a>
            <a href="{% url 'core:contact' %}" class="btn btn-outline-dark">
                <i class="fas fa-envelope me-2"></i>Contact Us
            </a>
        </div>
    </div>
    {% endif %}
</div>

<!-- Minimal CSS for shop enhancements -->
<style>
    /* Hover effects */
    .hover-lift {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .hover-lift:hover {
        transform: translateY(-8px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15) !important;
    }
    
    .hover-shadow {
        transition: box-shadow 0.3s ease;
    }
    
    .hover-shadow:hover {
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1) !important;
    }
    
    .transition-all {
        transition: all 0.3s ease;
    }
    
    /* Object fit utility */
    .object-fit-cover {
        object-fit: cover;
        width: 100%;
    }
    
    /* Custom background colors */
    .bg-beige {
        background-color: #e0ddd8;
    }
    
    /* Button group responsive */
    @media (max-width: 768px) {
        .btn-group {
            flex-wrap: wrap;
        }
        
        .btn-group .btn {
            margin-bottom: 0.25rem;
        }
    }
    
    /* Product image animation on hover */
    .card-img-top {
        transition: transform 0.5s ease;
    }
    
    .card:hover .card-img-top {
        transform: scale(1.05);
    }
</style>

<!-- JavaScript for enhanced functionality -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Update quantity input based on stock
        document.querySelectorAll('input[name="quantity"]').forEach(function(input) {
            input.addEventListener('change', function() {
                const max = parseInt(this.max);
                const value = parseInt(this.value);
                
                if (value > max) {
                    this.value = max;
                    showToast('Maximum quantity available: ' + max, 'warning');
                }
                
                if (value < 1) {
                    this.value = 1;
                }
            });
        });
        
        // Add to cart with feedback
        document.querySelectorAll('form[action*="add_to_cart"]').forEach(function(form) {
            form.addEventListener('submit', function(e) {
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                
                // Show loading state
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Adding...';
                submitBtn.disabled = true;
                
                // Re-enable button after 2 seconds if still processing
                setTimeout(function() {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }, 2000);
            });
        });
        
        // Add to wishlist function
        window.addToWishlist = function(productId) {
            fetch('/shop/wishlist/add/' + productId + '/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Added to wishlist!', 'success');
                } else {
                    showToast(data.message || 'Please login to save items', 'warning');
                }
            })
            .catch(error => {
                showToast('Error saving to wishlist', 'error');
            });
        };
        
        // Utility function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Toast notification function
        function showToast(message, type = 'info') {
            const toastContainer = document.createElement('div');
            toastContainer.className = 'position-fixed bottom-0 end-0 p-3';
            toastContainer.style.zIndex = '9999';
            
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-bg-${type} border-0 show`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            document.body.appendChild(toastContainer);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                toastContainer.remove();
            }, 3000);
        }
    });
</script>
{% endblock %}