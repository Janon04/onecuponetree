{% extends "base.html" %}
{% load i18n static %}

{% block extra_css %}
<!-- Leaflet CSS CDN -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-sA+e2H1LG2/2l9LkA4QbF6YwQJbQ1r6tG2R3lA/2Q6A=" crossorigin=""/>
<style>
    #impact-map {
        height: 500px;
        width: 100%;
    }
    .stat-card {
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        text-align: center;
    }
    .stat-value {
        font-size: 2.5rem;
        font-weight: bold;
    }
    .dashboard-chart {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        padding: 2rem;
        margin-bottom: 2rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <h1 class="text-center mb-5">{% trans "Impact Dashboard" %}</h1>
    
    <div class="dashboard-chart mb-5">
        <h4 class="mb-4">{% trans "Trees Planted Per Month" %}</h4>
        <canvas id="treesPlantedChart" height="100"></canvas>
    </div>
    <div class="dashboard-chart mb-5">
        <h4 class="mb-4">{% trans "Donations Per Month" %}</h4>
        <canvas id="donationsPerMonthChart" height="100"></canvas>
    </div>
    <div class="row mb-5">
        <div class="col-md-3">
            <div class="stat-card bg-success text-white">
                <div class="stat-value">{{ stats.trees_planted }}</div>
                <div class="stat-label">{% trans "Trees Planted" %}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card bg-primary text-white">
                <div class="stat-value">{{ stats.farmers_supported }}</div>
                <div class="stat-label">{% trans "Farmers Supported" %}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card bg-warning text-white">
                <div class="stat-value">{{ stats.youth_trained }}</div>
                <div class="stat-label">{% trans "Youth Trained" %}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card bg-info text-white">
                <div class="stat-value">{{ stats.reusable_cups }}</div>
                <div class="stat-label">{% trans "Reusable Cups" %}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card bg-danger text-white">
                <div class="stat-value">{{ stats.total_donations|floatformat:0 }}</div>
                <div class="stat-label">{% trans "Total Donations (RWF)" %}</div>
            </div>
        </div>
    </div>
    
    <!-- COâ‚‚ Offset card removed as requested -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    {% trans "Recent Trees Planted" %}
                </div>
                <div class="card-body">
                    <ul class="list-group">
                        {% for tree in recent_trees %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ tree.species }}
                            <span class="badge badge-primary badge-pill">{{ tree.planted_date }}</span>
                            {% if tree.latitude and tree.longitude %}
                                <span class="badge badge-info ms-2">{{ tree.latitude }}, {{ tree.longitude }}</span>
                            {% else %}
                                <span class="badge bg-warning text-dark ms-2">No coordinates</span>
                            {% endif %}
                        </li>
<!-- Admin note: To display trees on the map, make sure each tree has latitude and longitude set in the admin panel. -->
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card mb-5">
        <div class="card-header bg-secondary text-white">
            {% trans "Tree Planting Locations" %}
        </div>
        <div class="card-body p-0">
            <div id="impact-map"></div>
        <script id="map-trees-data" type="application/json">{{ map_trees|safe }}</script>
        </div>
    </div>
    
    <h2 class="text-center mb-4">{% trans "Success Stories" %}</h2>
    <div class="row">
        {% for testimonial in testimonials %}
        <div class="col-md-4 mb-4">
            <div class="card h-100">
                {% if testimonial.video %}
                <video class="card-img-top" controls style="width:100%;height:auto;max-height:220px;object-fit:cover;">
                    <source src="{{ testimonial.video.url }}" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
                {% elif testimonial.photo %}
                <img src="{{ testimonial.photo.url }}" class="card-img-top" alt="Testimonial photo">
                {% endif %}
                <div class="card-body">
                    <blockquote class="blockquote mb-0">
                        <p>{{ testimonial.content }}</p>
                        <footer class="blockquote-footer"><cite>{{ testimonial.role }}</cite></footer>
                    </blockquote>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="card mb-5">
        <div class="card-header bg-success text-white">
            {% trans "Recent Donations" %}
        </div>
        <div class="card-body p-0">
            <ul class="list-group">
                {% for donation in recent_donations %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>{{ donation.donor_name|default:'Anonymous' }} ({{ donation.amount|floatformat:0 }} RWF)</span>
                    <span class="badge bg-primary">{{ donation.get_donation_type_display }}</span>
                    <span class="text-muted small">{{ donation.created_at|date:'Y-m-d H:i' }}</span>
                </li>
                {% empty %}
                <li class="list-group-item">No donations yet.</li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JS CDN -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-o9N1jRVv6bQ8b+gk+g1Q9Q1Q9Q1Q9Q1Q9Q1Q9Q1Q9Q1Q=" crossorigin=""></script>
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Map initialization
function map_init(map, options) {
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    var markers = [];
    var mapTrees = [];
    try {
        mapTrees = JSON.parse(document.getElementById('map-trees-data').textContent);
    } catch (e) {}
    mapTrees.forEach(function(tree) {
        var marker = L.marker([tree.latitude, tree.longitude]).addTo(map)
            .bindPopup(`<b>Tree ${tree.tree_id}</b><br>${tree.species}<br>Planted on ${tree.planted_date}`);
        markers.push([tree.latitude, tree.longitude]);
    });
    if (markers.length > 0) {
        map.fitBounds(markers);
    }
}

// Chart.js: Trees Planted Per Month
const treesPlantedData = {
    labels: {{ month_labels|safe }},
    datasets: [{
        label: "Trees Planted",
    data: {{ trees_month_data|safe }},
        backgroundColor: "rgba(40, 167, 69, 0.5)",
        borderColor: "#28a745",
        borderWidth: 2,
        fill: true,
        tension: 0.4
    }]
};
const ctxTrees = document.getElementById('treesPlantedChart').getContext('2d');
new Chart(ctxTrees, {
    type: 'line',
    data: treesPlantedData,
    options: {
        responsive: true,
        plugins: {
            legend: { display: false },
            title: { display: false }
        },
        scales: {
            y: { beginAtZero: true }
        }
    }
});

const donationsPerMonthData = {
    labels: {{ month_labels|safe }},
    datasets: [{
        label: "Donations (RWF)",
    data: {{ donations_month_data|safe }},
        backgroundColor: "rgba(23, 162, 184, 0.5)",
        borderColor: "#17a2b8",
        borderWidth: 2,
        fill: true,
        tension: 0.4
    }]
};
const ctxDonations = document.getElementById('donationsPerMonthChart').getContext('2d');
new Chart(ctxDonations, {
    type: 'bar',
    data: donationsPerMonthData,
    options: {
        responsive: true,
        plugins: {
            legend: { display: false },
            title: { display: false }
        },
        scales: {
            y: { beginAtZero: true }
        }
    }
});
</script>
{% endblock %}