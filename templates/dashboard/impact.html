<div class="mb-4 d-flex justify-content-end">
    <a href="/admin/trees/tree/add/" class="btn btn-outline-success me-2" target="_blank">
        <i class="fas fa-plus-circle"></i> Add New Tree (with Coordinates)
    </a>
    <a href="/admin/trees/tree/" class="btn btn-outline-primary me-2" target="_blank">
        <i class="fas fa-edit"></i> Edit Tree Coordinates
    </a>
    <a href="https://leafletjs.com/examples/quick-start/" class="btn btn-outline-info" target="_blank">
        <i class="fas fa-map-marked-alt"></i> Map Setup Help
    </a>
</div>
{% extends "base.html" %}
{% load static i18n %}

{% block extra_css %}
<!-- Leaflet CSS CDN -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-sA+e2H1LG2/2l9LkA4QbF6YwQJbQ1r6tG2R3lA/2Q6A=" crossorigin=""/>
<style>
    #impact-map {
        height: 500px;
        width: 100%;
    }
    .stat-card {
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        text-align: center;
    }
    .stat-value {
        font-size: 2.5rem;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <h1 class="text-center mb-5">{% trans "Impact Dashboard" %}</h1>
    
    <div class="row mb-5">
        <div class="col-md-3">
            <div class="stat-card bg-success text-white">
                <div class="stat-value">{{ stats.trees_planted }}</div>
                <div class="stat-label">{% trans "Trees Planted" %}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card bg-primary text-white">
                <div class="stat-value">{{ stats.farmers_supported }}</div>
                <div class="stat-label">{% trans "Farmers Supported" %}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card bg-warning text-white">
                <div class="stat-value">{{ stats.youth_trained }}</div>
                <div class="stat-label">{% trans "Youth Trained" %}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card bg-info text-white">
                <div class="stat-value">{{ stats.reusable_cups }}</div>
                <div class="stat-label">{% trans "Reusable Cups" %}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card bg-danger text-white">
                <div class="stat-value">{{ stats.total_donations|floatformat:0 }}</div>
                <div class="stat-label">{% trans "Total Donations (RWF)" %}</div>
            </div>
        </div>
    </div>
    
    <!-- COâ‚‚ Offset card removed as requested -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    {% trans "Recent Trees Planted" %}
                </div>
                <div class="card-body">
                    <ul class="list-group">
                        {% for tree in recent_trees %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ tree.species }} ({{ tree.tree_id }})
                            <span class="badge badge-primary badge-pill">{{ tree.planted_date }}</span>
                            {% if tree.latitude and tree.longitude %}
                                <span class="badge badge-info ms-2">{{ tree.latitude }}, {{ tree.longitude }}</span>
                            {% else %}
                                <span class="badge bg-warning text-dark ms-2">No coordinates</span>
                            {% endif %}
                        </li>
<!-- Admin note: To display trees on the map, make sure each tree has latitude and longitude set in the admin panel. -->
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card mb-5">
        <div class="card-header bg-secondary text-white">
            {% trans "Tree Planting Locations" %}
        </div>
        <div class="card-body p-0">
            <div id="impact-map"></div>
        </div>
    </div>
    
    <h2 class="text-center mb-4">{% trans "Success Stories" %}</h2>
    <div class="row">
        {% for testimonial in testimonials %}
        <div class="col-md-4 mb-4">
            <div class="card h-100">
                {% if testimonial.photo %}
                <img src="{{ testimonial.photo.url }}" class="card-img-top" alt="{{ testimonial.author }}">
                {% endif %}
                <div class="card-body">
                    <blockquote class="blockquote mb-0">
                        <p>{{ testimonial.content }}</p>
                        <footer class="blockquote-footer">{{ testimonial.author }} <cite>{{ testimonial.role }}</cite></footer>
                    </blockquote>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="card mb-5">
        <div class="card-header bg-success text-white">
            {% trans "Recent Donations" %}
        </div>
        <div class="card-body p-0">
            <ul class="list-group">
                {% for donation in recent_donations %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>{{ donation.donor_name|default:'Anonymous' }} ({{ donation.amount|floatformat:0 }} RWF)</span>
                    <span class="badge bg-primary">{{ donation.get_donation_type_display }}</span>
                    <span class="text-muted small">{{ donation.created_at|date:'Y-m-d H:i' }}</span>
                </li>
                {% empty %}
                <li class="list-group-item">No donations yet.</li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JS CDN -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-o9N1jRVv6bQ8b+gk+g1Q9Q1Q9Q1Q9Q1Q9Q1Q9Q1Q9Q1Q=" crossorigin=""></script>
<script>
    function map_init(map, options) {
        // Add base layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        // Add trees to the map using latitude and longitude
        var markers = [];
        {% for tree in map_trees %}
        var marker = L.marker([{{ tree.latitude }}, {{ tree.longitude }}]).addTo(map)
            .bindPopup("<b>Tree {{ tree.tree_id }}</b><br>{{ tree.species }}<br>Planted on {{ tree.planted_date }}");
        markers.push([{{ tree.latitude }}, {{ tree.longitude }}]);
        {% endfor %}
        if (markers.length > 0) {
            map.fitBounds(markers);
        }
    }
</script>
{% endblock %}